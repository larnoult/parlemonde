!function($){fieldmaster.fields.repeater=fieldmaster.field.extend({type:"repeater",$el:null,$input:null,$table:null,$tbody:null,$clone:null,actions:{ready:"initialize",append:"initialize",show:"show"},events:{'click a[data-event="add-row"]':"_add",'click a[data-event="remove-row"]':"_remove",'click a[data-event="collapse-row"]':"_collapse","mouseenter td.order":"_mouseenter"},focus:function(){this.$el=this.$field.find(".fieldmaster-repeater:first"),this.$input=this.$field.find("input:first"),this.$table=this.$field.find("table:first"),this.$tbody=this.$table.children("tbody"),this.$clone=this.$tbody.children("tr.fieldmaster-clone"),this.o=fieldmaster.get_data(this.$el),this.o.min=this.o.min||0,this.o.max=this.o.max||0},initialize:function(){fieldmaster.disable_form(this.$clone,"repeater"),this.render()},show:function(){this.$tbody.find(".fm-field:visible").each(function(){fieldmaster.do_action("show_field",$(this))})},count:function(){return this.$tbody.children().length-1},render:function(){this.$tbody.children().each(function(e){$(this).find("> td.order > span").html(e+1)}),0==this.count()?this.$el.addClass("-empty"):this.$el.removeClass("-empty"),this.o.max>0&&this.count()>=this.o.max?this.$el.find("> .fieldmaster-actions .button").addClass("disabled"):this.$el.find("> .fieldmaster-actions .button").removeClass("disabled")},add:function(e){if(e=e||this.$clone,this.o.max>0&&this.count()>=this.o.max)return alert(fieldmaster._e("repeater","max").replace("{max}",this.o.max)),!1;var t=this.$field;return $el=fieldmaster.duplicate(this.$clone),$el.removeClass("fieldmaster-clone"),fieldmaster.enable_form($el,"repeater"),e.before($el),this.doFocus(t),this.render(),fieldmaster.validation.remove_error(this.$field),this.sync(),$el},remove:function(e){var t=this;return this.count()<=this.o.min?(alert(fieldmaster._e("repeater","min").replace("{min}",this.o.min)),!1):(fieldmaster.do_action("remove",e),void fieldmaster.remove_tr(e,function(){t.$input.trigger("change"),t.render(),t.sync(),fieldmaster.do_action("refresh",t.$field)}))},sync:function(){var e="collapsed_"+this.$field.data("key"),t=[];this.$tbody.children().each(function(e){$(this).hasClass("-collapsed")&&t.push(e)}),fieldmaster.update_user_setting(e,t.join(","))},_mouseenter:function(e){if(!this.$tbody.hasClass("ui-sortable")&&1!=this.o.max){var t=this;this.$tbody.sortable({items:"> tr",handle:"> td.order",forceHelperSize:!0,forcePlaceholderSize:!0,scroll:!0,start:function(e,t){fieldmaster.do_action("sortstart",t.item,t.placeholder)},stop:function(e,a){t.render(),fieldmaster.do_action("sortstop",a.item,a.placeholder)},update:function(e,a){t.$input.trigger("change")}})}},_add:function(e){$row=!1,e.$el.hasClass("fieldmaster-icon")&&($row=e.$el.closest(".fieldmaster-row")),this.add($row)},_remove:function(e){this.remove(e.$el.closest(".fieldmaster-row"))},_collapse:function(e){var t=e.$el.closest(".fieldmaster-row"),a=this.$field;t.hasClass("-collapsed")?(t.removeClass("-collapsed"),fieldmaster.do_action("show",t,"collapse")):(t.addClass("-collapsed"),fieldmaster.do_action("hide",t,"collapse")),this.set("$field",a).sync(),fieldmaster.do_action("refresh",this.$field)}})}(jQuery),function($){fieldmaster.fields.flexible_content=fieldmaster.field.extend({type:"flexible_content",$el:null,$input:null,$values:null,$clones:null,actions:{ready:"initialize",append:"initialize",show:"show"},events:{'click [data-event="add-layout"]':"_open",'click [data-event="remove-layout"]':"_remove",'click [data-event="collapse-layout"]':"_collapse","click .fieldmaster-fc-layout-handle":"_collapse","click .fieldmaster-fc-popup a":"_add","blur .fieldmaster-fc-popup .focus":"_close","mouseenter .fieldmaster-fc-layout-handle":"_mouseenter"},focus:function(){this.$el=this.$field.find(".fieldmaster-flexible-content:first"),this.$input=this.$el.children("input"),this.$values=this.$el.children(".values"),this.$clones=this.$el.children(".clones"),this.o=fieldmaster.get_data(this.$el),this.o.min=this.o.min||0,this.o.max=this.o.max||0},count:function(){return this.$values.children(".layout").length},initialize:function(){fieldmaster.disable_form(this.$clones,"flexible_content"),this.render()},show:function(){this.$values.find(".fm-field:visible").each(function(){fieldmaster.do_action("show_field",$(this))})},render:function(){var e=this;this.$values.children(".layout").each(function(e){$(this).find("> .fieldmaster-fc-layout-handle .fieldmaster-fc-layout-order").html(e+1)}),0==this.count()?this.$el.addClass("empty"):this.$el.removeClass("empty"),this.o.max>0&&this.count()>=this.o.max?this.$el.find("> .fieldmaster-actions .button").addClass("disabled"):this.$el.find("> .fieldmaster-actions .button").removeClass("disabled")},render_layout_title:function(e){var t=e.children("input"),a=t.attr("name").replace("[fieldmaster_fc_layout]",""),i=fieldmaster.prepare_for_ajax({action:"fieldmaster/fields/flexible_content/layout_title",field_key:this.$field.data("key"),i:e.index(),layout:t.val(),value:fieldmaster.serialize(e,a)});$.ajax({url:fieldmaster.get("ajaxurl"),dataType:"html",type:"post",data:i,success:function(t){t&&e.find("> .fieldmaster-fc-layout-handle").html(t)}})},validate_add:function(e){e=e||"";var t=this.o.max,a=this.count();if(t&&a>=t){var i=1==t?"layout":"layouts",l=fieldmaster._e("flexible_content","max");return l=l.replace("{max}",t),l=l.replace("{identifier}",fieldmaster._e("flexible_content",i)),alert(l),!1}if(e){var n=$(this.$el.children(".tmpl-popup").html()),s=n.find('[data-layout="'+e+'"]'),c=parseInt(s.attr("data-max")),o=this.$values.children('.layout[data-layout="'+e+'"]').length;if(c>0&&o>=c){var i=1==c?"layout":"layouts",l=fieldmaster._e("flexible_content","max_layout");return l=l.replace("{max}",o),l=l.replace("{label}",'"'+s.text()+'"'),l=l.replace("{identifier}",fieldmaster._e("flexible_content",i)),alert(l),!1}}return!0},validate_remove:function(e){e=e||"";var t=this.o.min,a=this.count();if(t>0&&a<=t){var i=1==t?"layout":"layouts",l=fieldmaster._e("flexible_content","min")+", "+fieldmaster._e("flexible_content","remove");return l=l.replace("{min}",t),l=l.replace("{identifier}",fieldmaster._e("flexible_content",i)),l=l.replace("{layout}",fieldmaster._e("flexible_content","layout")),confirm(l)}if(e){var n=$(this.$el.children(".tmpl-popup").html()),s=n.find('[data-layout="'+e+'"]'),c=parseInt(s.attr("data-min")),o=this.$values.children('.layout[data-layout="'+e+'"]').length;if(c>0&&o<=c){var i=1==c?"layout":"layouts",l=fieldmaster._e("flexible_content","min_layout")+", "+fieldmaster._e("flexible_content","remove");return l=l.replace("{min}",o),l=l.replace("{label}",'"'+s.text()+'"'),l=l.replace("{identifier}",fieldmaster._e("flexible_content",i)),l=l.replace("{layout}",fieldmaster._e("flexible_content","layout")),confirm(l)}}return!0},sync:function(){var e="collapsed_"+this.$field.data("key"),t=[];this.$values.children(".layout").each(function(e){$(this).hasClass("-collapsed")&&t.push(e)}),fieldmaster.update_user_setting(e,t.join(","))},add:function(e,t){if(t=t||!1,!this.validate_add(e))return!1;var a=this.$field,i=this.$clones.children('.layout[data-layout="'+e+'"]');$el=fieldmaster.duplicate(i),fieldmaster.enable_form($el,"flexible_content"),this.$el.children(".no-value-message").hide(),t?t.before($el):this.$values.append($el),this.doFocus(a),this.render(),fieldmaster.validation.remove_error(this.$field),this.sync()},_mouseenter:function(e){if(!this.$values.hasClass("ui-sortable")&&1!=this.o.max){var t=this;this.$values.sortable({items:"> .layout",handle:"> .fieldmaster-fc-layout-handle",forceHelperSize:!0,forcePlaceholderSize:!0,scroll:!0,start:function(e,t){fieldmaster.do_action("sortstart",t.item,t.placeholder)},stop:function(e,a){t.render(),fieldmaster.do_action("sortstop",a.item,a.placeholder)},update:function(e,a){t.$input.trigger("change")}})}},_open:function(e){if(!this.validate_add())return!1;var t=this.$values,a=$(this.$el.children(".tmpl-popup").html());a.find("a").each(function(){var e=$(this),a=e.data("min")||0,i=e.data("max")||0,l=e.data("layout"),n=t.children('.layout[data-layout="'+l+'"]').length;if(i&&n>=i)return void e.addClass("disabled");if(a){var s=a-n,c=fieldmaster._e("flexible_content","required"),o=1==s?"layout":"layouts",c=c.replace("{required}",s);if(c=c.replace("{min}",a),c=c.replace("{label} ",""),c=c.replace("{identifier}",fieldmaster._e("flexible_content",o)),s>0){var r=$('<span class="badge"></span>').attr("title",c).text(s);e.append(r)}}}),e.$el.after(a),e.$el.closest(".fieldmaster-fc-layout-controlls").exists()&&a.closest(".layout").addClass("-open"),a.css({"margin-top":0-a.height()-e.$el.outerHeight()-15,"margin-left":(e.$el.outerWidth()-a.width())/2});var i=a.offset().top,l=($("#wpadminbar").height()||0)+30;i<l&&(a.css({"margin-top":15}),a.addClass("bottom")),a.children(".focus").trigger("focus")},_close:function(e){var t=e.$el.parent(),a=t.closest(".layout");a.removeClass("-open"),setTimeout(function(){t.remove()},200)},_add:function(e){var t=e.$el.closest(".fieldmaster-fc-popup"),a=e.$el.attr("data-layout"),i=!1;t.closest(".fieldmaster-fc-layout-controlls").exists()&&(i=t.closest(".layout")),this.add(a,i)},_remove:function(e){var t=this,a=e.$el.closest(".layout");if(this.validate_remove(a.attr("data-layout"))){var i=0,l=this.$el.children(".no-value-message");0==a.siblings(".layout").length&&(i=l.outerHeight()),fieldmaster.do_action("remove",a),fieldmaster.remove_el(a,function(){t.render(),t.$input.trigger("change"),i>0&&l.show(),t.sync()},i)}},_collapse:function(e){var t=e.$el.closest(".layout"),a=t.hasClass("-collapsed"),i=a?"show":"hide";this.render_layout_title(t),t.toggleClass("-collapsed"),this.sync(),fieldmaster.do_action(i,t,"collapse")}})}(jQuery),function($){fieldmaster.fields.gallery=fieldmaster.field.extend({type:"gallery",$el:null,$main:null,$side:null,$attachments:null,$input:null,actions:{ready:"initialize",append:"initialize",show:"resize"},events:{"click .fieldmaster-gallery-attachment":"_select","click .fieldmaster-gallery-add":"_add","click .fieldmaster-gallery-remove":"_remove","click .fieldmaster-gallery-close":"_close","change .fieldmaster-gallery-sort":"_sort","click .fieldmaster-gallery-edit":"_edit","click .fieldmaster-gallery-update":"_update","change .fieldmaster-gallery-side input":"_update","change .fieldmaster-gallery-side textarea":"_update","change .fieldmaster-gallery-side select":"_update"},focus:function(){this.$el=this.$field.find(".fieldmaster-gallery:first"),this.$main=this.$el.children(".fieldmaster-gallery-main"),this.$side=this.$el.children(".fieldmaster-gallery-side"),this.$attachments=this.$main.children(".fieldmaster-gallery-attachments"),this.$input=this.$el.find("input:first"),this.o=fieldmaster.get_data(this.$el),this.o.min=this.o.min||0,this.o.max=this.o.max||0},initialize:function(){var e=this,t=this.$field;this.$attachments.unbind("sortable").sortable({items:".fieldmaster-gallery-attachment",forceHelperSize:!0,forcePlaceholderSize:!0,scroll:!0,start:function(e,t){t.placeholder.html(t.item.html()),t.placeholder.removeAttr("style"),fieldmaster.do_action("sortstart",t.item,t.placeholder)},stop:function(e,t){fieldmaster.do_action("sortstop",t.item,t.placeholder)}}),this.$el.unbind("resizable").resizable({handles:"s",minHeight:200,stop:function(e,t){fieldmaster.update_user_setting("gallery_height",t.size.height)}}),$(window).on("resize",function(){e.set("$field",t).resize()}),this.render(),this.resize()},resize:function(){for(var e=100,t=175,a=4,i=this.$el.width(),l=4;l<20;l++){var n=i/l;if(e<n&&n<t){a=l;break}}a=Math.min(a,8),this.$el.attr("data-columns",a)},render:function(){var e=this.$main.find(".fieldmaster-gallery-sort"),t=this.$main.find(".fieldmaster-gallery-add");this.o.max>0&&this.count()>=this.o.max?t.addClass("disabled"):t.removeClass("disabled"),this.count()?e.removeClass("disabled"):e.addClass("disabled")},open_sidebar:function(){this.$el.addClass("sidebar-open"),this.$main.find(".fieldmaster-gallery-sort").hide();var e=this.$el.width()/3;e=parseInt(e),e=Math.max(e,350),this.$side.children(".fieldmaster-gallery-side-inner").css({width:e-1}),this.$side.animate({width:e-1},250),this.$main.animate({right:e},250)},_close:function(e){this.close_sidebar()},close_sidebar:function(){this.$el.removeClass("sidebar-open");var e=this.$el.find(".fieldmaster-gallery-sort");this.get_attachment("active").removeClass("active"),this.$side.find("input, textarea, select").attr("disabled","disabled"),this.$main.animate({right:0},250),this.$side.animate({width:0},250,function(){e.show(),$(this).find(".fieldmaster-gallery-side-data").html("")})},count:function(){return this.get_attachments().length},get_attachments:function(){return this.$attachments.children(".fieldmaster-gallery-attachment")},get_attachment:function(e){return e=e||0,e="active"===e?".active":'[data-id="'+e+'"]',this.$attachments.children(".fieldmaster-gallery-attachment"+e)},render_attachment:function(e){e=this.prepare(e);var t=this.get_attachment(e.id),a=t.find(".margin"),i=t.find("img"),l=t.find(".filename"),n=t.find('input[type="hidden"]'),s=e.url;"image"==e.type?l.remove():(s=fieldmaster.maybe_get(e,"thumb.src"),l.text(e.filename)),s||(s=fieldmaster._e("media","default_icon"),t.addClass("-icon")),i.attr({src:s,alt:e.alt,title:e.title}),fieldmaster.val(n,e.id)},_add:function(e){if(this.o.max>0&&this.count()>=this.o.max)return void fieldmaster.validation.add_warning(this.$field,fieldmaster._e("gallery","max"));var t=this,a=this.$field,i=fieldmaster.media.popup({title:fieldmaster._e("gallery","select"),mode:"select",type:"",field:this.$field.data("key"),multiple:"add",library:this.o.library,mime_types:this.o.mime_types,select:function(e,i){t.set("$field",a).add_attachment(e,i)}});i.on("content:activate:browse",function(){t.render_collection(i),i.content.get().collection.on("reset add",function(){t.render_collection(i)})})},add_attachment:function(e,t){if(t=t||0,e=this.prepare(e),!(this.o.max>0&&this.count()>=this.o.max||this.get_attachment(e.id).exists())){var a=this.$el.find('input[type="hidden"]:first').attr("name"),i=['<div class="fieldmaster-gallery-attachment fieldmaster-soh" data-id="'+e.id+'">','<input type="hidden" value="'+e.id+'" name="'+a+'[]">','<div class="margin" title="">','<div class="thumbnail">','<img src="" alt="">',"</div>",'<div class="filename"></div>',"</div>",'<div class="actions fieldmaster-soh-target">','<a href="#" class="fieldmaster-icon -cancel dark fieldmaster-gallery-remove" data-id="'+e.id+'"></a>',"</div>","</div>"].join(""),l=$(i);if(this.$attachments.append(l),"prepend"===this.o.insert){var n=this.$attachments.children(":eq("+t+")");n.exists()&&n.before(l)}this.render_attachment(e),this.render(),this.$input.trigger("change")}},_select:function(e){var t=e.$el.data("id");this.select_attachment(t)},select_attachment:function(e){var t=this.get_attachment(e);t.hasClass("active")||(this.$side.find(":focus").trigger("blur"),this.get_attachment("active").removeClass("active"),t.addClass("active"),this.fetch(e),this.open_sidebar())},prepare:function(e){if(e=e||{},e._valid)return e;var t={id:"",url:"",alt:"",title:"",filename:""};return e.id&&(t=e.attributes,t.url=fieldmaster.maybe_get(t,"sizes.medium.url",t.url)),t._valid=!0,t},fetch:function(e){var t=fieldmaster.prepare_for_ajax({action:"fieldmaster/fields/gallery/get_attachment",field_key:this.$field.data("key"),id:e});if(this.$el.data("xhr")&&this.$el.data("xhr").abort(),"string"==typeof e&&0===e.indexOf("_")){var a=this.get_attachment(e).find('input[type="hidden"]').val();a=$.parseJSON(a),t.attachment=a}var i=$.ajax({url:fieldmaster.get("ajaxurl"),dataType:"html",type:"post",cache:!1,data:t,context:this,success:this.fetch_success});this.$el.data("xhr",i)},fetch_success:function(e){if(e){var t=this.$side.find(".fieldmaster-gallery-side-data");t.html(e),t.find(".compat-field-fieldmaster-form-data").remove();var a=t.find("> .compat-attachment-fields > tbody > tr").detach();t.find("> table.form-table > tbody").append(a),t.find("> .compat-attachment-fields").remove(),fieldmaster.do_action("append",t)}},_sort:function(e){var t=e.$el.val();if(t){var a=fieldmaster.prepare_for_ajax({action:"fieldmaster/fields/gallery/get_sort_order",field_key:this.$field.data("key"),ids:[],sort:t});this.get_attachments().each(function(){var e=$(this).attr("data-id");e&&a.ids.push(e)});var i=$.ajax({url:fieldmaster.get("ajaxurl"),dataType:"json",type:"post",cache:!1,data:a,context:this,success:this._sort_success})}},_sort_success:function(e){if(fieldmaster.is_ajax_success(e)){e.data.reverse();for(i in e.data){var t=e.data[i],a=this.get_attachment(t);this.$attachments.prepend(a)}}},_update:function(){var e=this.$side.find(".fieldmaster-gallery-update"),t=this.$side.find(".fieldmaster-gallery-edit"),a=this.$side.find(".fieldmaster-gallery-side-data"),i=t.data("id"),l=fieldmaster.serialize_form(a);return!e.attr("disabled")&&(e.attr("disabled","disabled"),e.before('<i class="fieldmaster-loading"></i>'),l.action="fieldmaster/fields/gallery/update_attachment",fieldmaster.prepare_for_ajax(l),void $.ajax({url:fieldmaster.get("ajaxurl"),data:l,type:"post",dataType:"json",complete:function(t){e.removeAttr("disabled"),e.prev(".fieldmaster-loading").remove()}}))},_remove:function(e){e.stopPropagation();var t=e.$el.data("id");this.remove_attachment(t)},remove_attachment:function(e){this.close_sidebar(),this.get_attachment(e).remove(),this.render(),this.$input.trigger("change")},_edit:function(e){var t=e.$el.data("id");this.edit_attachment(t)},edit_attachment:function(e){var t=this,a=this.$field,i=fieldmaster.media.popup({mode:"edit",title:fieldmaster._e("image","edit"),button:fieldmaster._e("image","update"),attachment:e,select:function(i){t.set("$field",a).render_attachment(i),t.fetch(e)}})},render_collection:function(e){var t=this;setTimeout(function(){var a=e.content.get().$el;if(collection=e.content.get().collection||null,collection){var i=-1;collection.each(function(e){i++;var l=a.find(".attachments > .attachment:eq("+i+")");t.get_attachment(e.id).exists()&&(e.off("selection:single"),l.addClass("fieldmaster-selected"))})}},10)}});var e=fieldmaster.model.extend({actions:{validation_begin:"validation_begin",validation_failure:"validation_failure"},validation_begin:function(){$(".fieldmaster-gallery-side-data").each(function(){fieldmaster.disable_form($(this),"gallery")})},validation_failure:function(){$(".fieldmaster-gallery-side-data").each(function(){fieldmaster.enable_form($(this),"gallery")})}})}(jQuery);