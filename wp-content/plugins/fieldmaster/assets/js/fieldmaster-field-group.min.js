!function($){fieldmaster.field_group=fieldmaster.model.extend({$fields:null,$locations:null,$options:null,actions:{ready:"init"},events:{"submit #post":"submit",'click a[href="#"]':"preventDefault","click .submitdelete":"trash","mouseenter .fm-field-list":"sortable"},init:function(){this.$fields=$("#fm-field-group-fields"),this.$locations=$("#fm-field-group-locations"),this.$options=$("#fm-field-group-options"),fieldmaster.validation.active=0},sortable:function(e){if(!e.$el.hasClass("ui-sortable")){var i=this;e.$el.sortable({handle:".fieldmaster-sortable-handle",connectWith:".fm-field-list",update:function(e,t){var a=t.item;i.render_fields(),fieldmaster.do_action("sortstop",a)}})}},preventDefault:function(e){e.preventDefault()},get_selector:function(e){e=e||"";var i=".fm-field-object";return e&&(i+="-"+e,i=i.split("_").join("-")),i},render_fields:function(){var e=this;$(".fm-field-list").each(function(){var i=$(this).children(".fm-field-object");i.each(function(i){e.update_field_meta($(this),"menu_order",i),$(this).children(".handle").find(".fieldmaster-icon").html(i+1)}),i.exists()?$(this).children(".no-fields-message").hide():$(this).children(".no-fields-message").show()})},get_field_meta:function(e,i){var t=e.find("> .meta > .input-"+i);return!!t.exists()&&t.val()},update_field_meta:function(e,i,t){var a=e.find("> .meta > .input-"+i);if(!a.exists()){var d=e.find("> .meta > .input-ID").outerHTML();d=fieldmaster.str_replace("ID",i,d),a=$(d),a.val(t),e.children(".meta").append(a)}a.val()!=t&&(a.val(t),"save"!=i&&this.save_field(e,"meta"))},delete_field_meta:function(e,i){var t=e.find("> .meta > .input-"+i);t.exists()&&(t.remove(),this.save_field(e,"meta"))},save_field:function(e,i){i=i||"settings";var t=this.get_field_meta(e,"save");"settings"!=t&&t!=i&&(this.update_field_meta(e,"save",i),fieldmaster.do_action("save_field",e,i))},submit:function(e){var i=this,t=$("#titlewrap #title");t.val()||(e.preventDefault(),fieldmaster.validation.toggle(e.$el,"unlock"),alert(fieldmaster._e("title_is_required")),t.focus()),$(".fm-field-object").each(function(){var e=i.get_field_meta($(this),"save"),t=i.get_field_meta($(this),"ID"),a=$(this).hasClass("open");a&&i.close_field($(this)),"settings"==e||("meta"==e?$(this).children(".settings").find('[name^="fieldmaster_fields['+t+']"]').remove():$(this).find('[name^="fieldmaster_fields['+t+']"]').remove())})},trash:function(e){var i=confirm(fieldmaster._e("move_to_trash"));i||e.preventDefault()},render_field:function(e){var i=e.find(".field-label:first").val(),t=e.find(".field-name:first").val(),a=e.find(".field-type:first option:selected").text(),d=e.find(".field-required:first").prop("checked"),n=e.children(".handle");n.find(".li-field-label strong a").text(i),n.find(".li-field-label .fieldmaster-required").remove(),d&&n.find(".li-field-label strong").append('<span class="fieldmaster-required">*</span>'),n.find(".li-field-name").text(t),n.find(".li-field-type").text(a),fieldmaster.do_action("render_field_handle",e,n)},edit_field:function(e){e.hasClass("open")?this.close_field(e):this.open_field(e)},open_field:function(e){return!e.hasClass("open")&&(e.addClass("open"),fieldmaster.do_action("open_field",e),void e.children(".settings").animate({height:"toggle"},250))},close_field:function(e){return!!e.hasClass("open")&&(e.removeClass("open"),fieldmaster.do_action("close_field",e),void e.children(".settings").animate({height:"toggle"},250))},wipe_field:function(e){var i=e.attr("data-id"),t=e.attr("data-key"),a=fieldmaster.get_uniqid(),d="field_"+a;e.attr("data-id",a),e.attr("data-key",d),e.attr("data-orig",t),this.update_field_meta(e,"ID",""),this.update_field_meta(e,"key",d),e.find('[id*="'+i+'"]').each(function(){$(this).attr("id",$(this).attr("id").replace(i,a))}),e.find('[name*="'+i+'"]').each(function(){$(this).attr("name",$(this).attr("name").replace(i,a))}),e.find("> .handle .pre-field-key").text(d),e.find(".ui-sortable").removeClass("ui-sortable"),fieldmaster.do_action("wipe_field",e)},add_field:function(e){var i=$($("#tmpl-fm-field").html()),t=i.find(".field-label:first"),a=i.find(".field-name:first");this.wipe_field(i),e.append(i),t.val(""),a.val(""),setTimeout(function(){t.focus()},251),this.render_fields(),fieldmaster.do_action("append",i),this.edit_field(i),fieldmaster.do_action("add_field",i)},duplicate_field:function(e){fieldmaster.do_action("before_duplicate",e);var i=e.clone(),t=i.find(".field-label:first"),a=i.find(".field-name:first");fieldmaster.do_action("remove",i),this.wipe_field(i),fieldmaster.do_action("after_duplicate",e,i),e.after(i),fieldmaster.do_action("append",i),setTimeout(function(){t.focus()},251),this.render_fields(),e.hasClass("open")?this.close_field(e):this.open_field(i);var d=t.val(),n=a.val(),l=n.split("_").pop(),f=fieldmaster._e("copy");if(0===l.indexOf(f)){var c=1*l.replace(f,"");c=c?c+1:2,d=d.replace(l,f+c),n=n.replace(l,f+c)}else d+=" ("+f+")",n+="_"+f;return t.val(d),a.val(n),this.save_field(i),this.render_field(i),fieldmaster.do_action("duplicate_field",i),i},move_field:function(e){var i=this,t=fieldmaster.prepare_for_ajax({action:"fieldmaster/field_group/move_field",field_id:this.get_field_meta(e,"ID")}),a=!1;return t.field_id?"settings"==this.get_field_meta(e,"save")?a=!0:e.find(".fm-field-object").each(function(){return i.get_field_meta($(this),"ID")?void("settings"==i.get_field_meta($(this),"save")&&(a=!0)):(a=!0,!1)}):a=!0,a?void alert(fieldmaster._e("move_field_warning")):(fieldmaster.open_popup({title:fieldmaster._e("move_field"),loading:!0,height:145}),void $.ajax({url:fieldmaster.get("ajaxurl"),data:t,type:"post",dataType:"html",success:function(t){i.move_field_confirm(e,t)}}))},move_field_confirm:function(e,i){var t=this;fieldmaster.update_popup({content:i});var a=fieldmaster.prepare_for_ajax({action:"fieldmaster/field_group/move_field",field_id:this.get_field_meta(e,"ID"),field_group_id:0});$("#fieldmaster-move-field-form").on("submit",function(){return a.field_group_id=$(this).find("select").val(),$.ajax({url:fieldmaster.get("ajaxurl"),data:a,type:"post",dataType:"html",success:function(i){fieldmaster.update_popup({content:i}),t.remove_field(e)}}),!1})},delete_field:function(e,i){i=i||!0;var t=this.get_field_meta(e,"ID");t&&$("#input-delete-fields").val($("#input-delete-fields").val()+"|"+t),fieldmaster.do_action("delete_field",e),i&&this.remove_field(e)},remove_field:function(e){var i=this,t=e.closest(".fm-field-list");e.css({height:e.height(),width:e.width(),position:"absolute"}),e.wrap('<div class="temp-field-wrap" style="height:'+e.height()+'px"></div>'),e.animate({opacity:0},250);var a=0,d=!1;t.children(".fm-field-object").length||(d=t.children(".no-fields-message"),a=d.outerHeight()),e.parent(".temp-field-wrap").animate({height:a},250,function(){d&&d.show(),fieldmaster.do_action("remove",$(this)),$(this).remove(),i.render_fields()})},change_field_type:function(e){var i=e.closest("tbody"),t=i.closest(".fm-field-object"),a=t.parent().closest(".fm-field-object"),d=t.attr("data-key"),n=t.attr("data-type"),l=e.val();t.removeClass("fm-field-object-"+fieldmaster.str_replace("_","-",n)),t.addClass("fm-field-object-"+fieldmaster.str_replace("_","-",l)),t.attr("data-type",l),t.data("type",l),t.data("xhr")&&t.data("xhr").abort();var f=i.children('.fm-field[data-setting="'+n+'"]'),c="";if(f.each(function(){c+=$(this).outerHTML()}),f.remove(),fieldmaster.update(d+"_settings_"+n,c),this.render_field(t),c=fieldmaster.get(d+"_settings_"+l))return i.children('.fm-field[data-name="conditional_logic"]').before(c),fieldmaster.update(d+"_settings_"+l,""),void fieldmaster.do_action("change_field_type",t);var o=$('<tr class="fm-field"><td class="fieldmaster-label"></td><td class="fieldmaster-input"><div class="fieldmaster-loading"></div></td></tr>');i.children('.fm-field[data-name="conditional_logic"]').before(o);var r={action:"fieldmaster/field_group/render_field_settings",nonce:fieldmaster.o.nonce,parent:fieldmaster.o.post_id,field_group:fieldmaster.o.post_id,prefix:e.attr("name").replace("[type]",""),type:l};a.exists()&&(r.parent=this.get_field_meta(a,"ID"));var s=$.ajax({url:fieldmaster.o.ajaxurl,data:r,type:"post",dataType:"html",success:function(e){if(e){var i=$(e);o.after(i),fieldmaster.do_action("append",i),fieldmaster.do_action("change_field_type",t)}},complete:function(){o.remove()}});t.data("xhr",s)},change_field_label:function(e){var i=e.find(".field-label:first"),t=e.find(".field-name:first"),a=e.attr("data-type");if(""==t.val()){var d=i.val();d=fieldmaster.str_sanitize(d),t.val(d).trigger("change")}this.render_field(e),fieldmaster.do_action("change_field_label",e)},change_field_name:function(e){var i=e.find(".field-name:first");"field_"===i.val().substr(0,6)&&(alert(fieldmaster._e("field_name_start")),setTimeout(function(){i.focus()},1)),fieldmaster.do_action("change_field_name",e)}}),fieldmaster.field_group.field=fieldmaster.model.extend({events:{"click .edit-field":"edit","click .duplicate-field":"duplicate","click .move-field":"move","click .delete-field":"delete","click .add-field":"add","change .field-type":"change_type","blur .field-label":"change_label","blur .field-name":"change_name","keyup .field-label":"render","keyup .field-name":"render","change .field-required":"render","change .fm-field-object input":"save","change .fm-field-object textarea":"save","change .fm-field-object select":"save"},event:function(e){return e.$field=e.$el.closest(".fm-field-object"),e},edit:function(e){fieldmaster.field_group.edit_field(e.$field)},duplicate:function(e){fieldmaster.field_group.duplicate_field(e.$field)},move:function(e){fieldmaster.field_group.move_field(e.$field)},delete:function(e){fieldmaster.field_group.delete_field(e.$field)},add:function(e){var i=e.$el.closest(".fm-field-list-wrap").children(".fm-field-list");fieldmaster.field_group.add_field(i)},change_type:function(e){fieldmaster.field_group.change_field_type(e.$el)},change_label:function(e){fieldmaster.field_group.change_field_label(e.$field)},change_name:function(e){fieldmaster.field_group.change_field_name(e.$field)},render:function(e){fieldmaster.field_group.render_field(e.$field)},save:function(e){fieldmaster.field_group.save_field(e.$field)}}),fieldmaster.field_group.conditional_logic=fieldmaster.model.extend({actions:{open_field:"render_field",change_field_label:"render_fields",change_field_type:"render_fields"},events:{"click .add-conditional-rule":"add_rule","click .add-conditional-group":"add_group","click .remove-conditional-rule":"remove_rule","change .conditional-toggle":"change_toggle","change .conditional-rule-param":"change_param"},render_fields:function(){var e=this;$(".fm-field-object.open").each(function(){e.render_field($(this))})},render_field:function(e){var i=this,t=e.attr("data-key"),a=e.parents(".fm-field-list"),d=e.find('.fm-field[data-name="conditional_logic"]:last'),n=[];$.each(a,function(e){var i=0==e?fieldmaster._e("sibling_fields"):fieldmaster._e("parent_fields");$(this).children(".fm-field-object").each(function(){var e=$(this),a=e.attr("data-key"),d=e.attr("data-type"),l=e.find(".field-label:first").val();$.inArray(d,["select","checkbox","true_false","radio"])!==-1&&a!=t&&n.push({value:a,label:l,group:i})})}),n.length||n.push({value:"",label:fieldmaster._e("no_fields")}),d.find(".rule").each(function(){i.render_rule($(this),n)})},render_rule:function(e,i){var t=e.find(".conditional-rule-param"),a=e.find(".conditional-rule-value");i&&fieldmaster.render_select(t,i);var d=$('.fm-field-object[data-key="'+t.val()+'"]'),n=d.attr("data-type"),l=[];if("true_false"==n)l.push({value:1,label:fieldmaster._e("checked")});else if("select"==n||"checkbox"==n||"radio"==n){var f=d.find('.fm-field[data-name="choices"] textarea').val().split("\n");$.each(f,function(e,i){i=i.split(":"),i[1]=i[1]||i[0],l.push({value:$.trim(i[0]),label:$.trim(i[1])})});var c=d.find('.fm-field[data-name="allow_null"]');c.exists()&&"1"==c.find("input:checked").val()&&l.unshift({value:"",label:fieldmaster._e("null")})}fieldmaster.render_select(a,l)},change_toggle:function(e){var i=e.$el,t=e.$el.prop("checked"),a=i.closest(".fieldmaster-input");t?(a.find(".rule-groups").show(),a.find(".rule-groups").find("[name]").prop("disabled",!1)):(a.find(".rule-groups").hide(),a.find(".rule-groups").find("[name]").prop("disabled",!0))},change_param:function(e){var i=e.$el.closest(".rule");this.render_rule(i)},add_rule:function(e){var i=e.$el.closest("tr");$tr2=fieldmaster.duplicate(i),$tr2.find("select:first").trigger("change")},remove_rule:function(e){var i=e.$el.closest("tr");i.find("select:first").trigger("change"),0==i.siblings("tr").length&&i.closest(".rule-group").remove(),i.remove()},add_group:function(e){var i=e.$el.closest(".rule-groups"),t=i.find(".rule-group:last");$group2=fieldmaster.duplicate(t),$group2.find("h4").text(fieldmaster._e("or")),$group2.find("tr:not(:first)").remove(),$group2.find("select:first").trigger("change")}}),fieldmaster.field_group.locations=fieldmaster.model.extend({events:{"click .add-location-rule":"add_rule","click .add-location-group":"add_group","click .remove-location-rule":"remove_rule","change .location-rule-param":"change_rule"},add_rule:function(e){var i=e.$el.closest("tr");$tr2=fieldmaster.duplicate(i)},remove_rule:function(e){var i=e.$el.closest("tr");i.find("select:first").trigger("change"),0==i.siblings("tr").length&&i.closest(".rule-group").remove(),i.remove()},add_group:function(e){var i=e.$el.closest(".rule-groups"),t=i.find(".rule-group:last");$group2=fieldmaster.duplicate(t),$group2.find("h4").text(fieldmaster._e("or")),$group2.find("tr:not(:first)").remove()},change_rule:function(e){var i=e.$el,t=i.closest("tr"),a=t.attr("data-id"),d=t.closest(".rule-group"),n=d.attr("data-id"),l=$('<div class="fieldmaster-loading"></div>');t.find("td.value").html(l),$.ajax({url:fieldmaster.get("ajaxurl"),data:fieldmaster.prepare_for_ajax({action:"fieldmaster/field_group/render_location_value",rule_id:a,group_id:n,param:i.val(),value:""}),type:"post",dataType:"html",success:function(e){l.replaceWith(e)}})}}),fieldmaster.field_group.field_object=fieldmaster.model.extend({type:"",o:{},$field:null,$settings:null,_add_action:function(e,i){var t=this,a=e.split("_");a.splice(1,0,"field"),e=a.join("_")+"/type="+t.type,fieldmaster.add_action(e,function(e){t.set("$field",e),t[i].apply(t,arguments)})},_add_filter:function(e,i){var t=this,a=e.split("_");a.splice(1,0,"field"),e=a.join("_")+"/type="+t.type,fieldmaster.add_filter(e,function(e){t.set("$field",e),t[i].apply(t,arguments)})},_add_event:function(e,i){var t=this,a=e.substr(0,e.indexOf(" ")),d=e.substr(e.indexOf(" ")+1),n=fieldmaster.field_group.get_selector(t.type);$(document).on(a,n+" "+d,function(e){e.$el=$(this),e.$field=e.$el.closest(".fm-field-object"),t.set("$field",e.$field),t[i].apply(t,[e])})},_set_$field:function(){this.o=this.$field.data(),this.$settings=this.$field.find("> .settings > table > tbody"),this.focus()},focus:function(){},setting:function(e){return this.$settings.find("> .fm-field-setting-"+e)}}),fieldmaster.field_group.field_objects=fieldmaster.model.extend({actions:{save_field:"_save_field",open_field:"_open_field",close_field:"_close_field",wipe_field:"_wipe_field",add_field:"_add_field",duplicate_field:"_duplicate_field",delete_field:"_delete_field",change_field_type:"_change_field_type",change_field_label:"_change_field_label",change_field_name:"_change_field_name",render_field_settings:"_render_field_settings"},_save_field:function(e){fieldmaster.do_action("save_field/type="+e.data("type"),e)},_open_field:function(e){fieldmaster.do_action("open_field/type="+e.data("type"),e),fieldmaster.do_action("render_field_settings",e)},_close_field:function(e){fieldmaster.do_action("close_field/type="+e.data("type"),e)},_wipe_field:function(e){fieldmaster.do_action("wipe_field/type="+e.data("type"),e)},_add_field:function(e){fieldmaster.do_action("add_field/type="+e.data("type"),e)},_duplicate_field:function(e){fieldmaster.do_action("duplicate_field/type="+e.data("type"),e)},_delete_field:function(e){fieldmaster.do_action("delete_field/type="+e.data("type"),e)},_change_field_type:function(e){fieldmaster.do_action("change_field_type/type="+e.data("type"),e),fieldmaster.do_action("render_field_settings",e)},_change_field_label:function(e){fieldmaster.do_action("change_field_label/type="+e.data("type"),e)},_change_field_name:function(e){fieldmaster.do_action("change_field_name/type="+e.data("type"),e)},_render_field_settings:function(e){fieldmaster.do_action("render_field_settings/type="+e.data("type"),e)}}),fieldmaster.field_group.append=fieldmaster.model.extend({actions:{render_field_settings:"_render_field_settings"},render:function(e){var i=e.data("append");if($sibling=e.siblings('[data-name="'+i+'"]'),$sibling.exists()){var t=$sibling.children(".fieldmaster-input"),a=t.children(".fieldmaster-hl");a.exists()||(t.wrapInner('<ul class="fieldmaster-hl"><li></li></ul>'),a=t.children(".fieldmaster-hl"));var d=$("<li></li>").append(e.children(".fieldmaster-input").children());a.append(d),a.attr("data-cols",a.children().length),e.remove()}},_render_field_settings:function(e){var i=this;e.find(".fm-field[data-append]").each(function(){i.render($(this))})}});var e=fieldmaster.field_group.field_object.extend({type:"select",actions:{render_settings:"render"},events:{"change .fm-field-setting-ui input":"render"},render:function(e){this.setting('ui input[type="checkbox"]').prop("checked")?this.setting("ajax").show():(this.setting("ajax").hide(),this.setting('ajax input[type="checkbox"]').prop("checked",!1).trigger("change"))}}),i=fieldmaster.field_group.field_object.extend({type:"radio",actions:{render_settings:"render"},events:{"change .fm-field-setting-other_choice input":"render"},render:function(e){this.setting('other_choice input[type="checkbox"]').prop("checked")?this.setting("save_other_choice").show():(this.setting("save_other_choice").hide(),this.setting('save_other_choice input[type="checkbox"]').prop("checked",!1).trigger("change"))}}),t=fieldmaster.field_group.field_object.extend({type:"true_false",actions:{render_settings:"render"},events:{"change .fm-field-setting-ui input":"render"},render:function(e){this.setting('ui input[type="checkbox"]').prop("checked")?(this.setting("ui_on_text").show(),this.setting("ui_off_text").show()):(this.setting("ui_on_text").hide(),this.setting("ui_off_text").hide())}}),a=fieldmaster.field_group.field_object.extend({type:"date_picker",actions:{render_settings:"render"},events:{"change .fm-field-setting-display_format input":"render","change .fm-field-setting-return_format input":"render"},render:function(e){this.render_list(this.setting("display_format")),this.render_list(this.setting("return_format"))},render_list:function(e){var i=e.find("ul"),t=i.find('input[type="radio"]:checked'),a=i.find('input[type="text"]');"other"!=t.val()&&a.val(t.val())}}),d=a.extend({type:"date_time_picker"}),d=a.extend({type:"time_picker"}),n=fieldmaster.field_group.field_object.extend({type:"tab",actions:{render_settings:"render"},render:function(e){this.setting("name input").val("").trigger("change"),this.setting('required input[type="checkbox"]').prop("checked",!1).trigger("change")}}),l=n.extend({type:"message"});fieldmaster.field_group.screen=fieldmaster.model.extend({actions:{ready:"ready"},events:{"click #fm-field-key-hide":"toggle"},ready:function(){var e=$("#adv-settings"),i=e.find("#fieldmaster-append-show-on-screen");e.find(".metabox-prefs").append(i.html()),e.find(".metabox-prefs br").remove(),i.remove(),this.render()},toggle:function(e){var i=e.$el.prop("checked")?1:0;fieldmaster.update_user_setting("show_field_keys",i),this.render()},render:function(){var e=fieldmaster.serialize_form($("#adv-settings"));e.show_field_keys=parseInt(e.show_field_keys);var i=fieldmaster.field_group.$fields;e.show_field_keys?i.addClass("show-field-keys"):i.removeClass("show-field-keys")}}),fieldmaster.field_group.sub_fields=fieldmaster.model.extend({actions:{open_field:"update_field_parent",sortstop:"update_field_parent",duplicate_field:"duplicate_field",delete_field:"delete_field",change_field_type:"change_field_type"},fix_conditional_logic:function(e){var i={};e.each(function(){i[$(this).attr("data-orig")]=$(this).attr("data-key")}),e.find(".conditional-rule-param").each(function(){var e=$(this).val();e in i&&($(this).find('option[value="'+i[e]+'"]').exists()||$(this).append('<option value="'+i[e]+'">'+i[e]+"</option>"),$(this).val(i[e]))})},update_field_parent:function(e){if(e.hasClass("fm-field-object")){var i=e.parent().closest(".fm-field-object"),t=fieldmaster.get("post_id");i.exists()&&(t=fieldmaster.field_group.get_field_meta(i,"ID"),t||(t=fieldmaster.field_group.get_field_meta(i,"key"))),fieldmaster.field_group.update_field_meta(e,"parent",t),fieldmaster.do_action("update_field_parent",e,i)}},duplicate_field:function(e){var i=e.find(".fm-field-object");i.exists()&&(i.each(function(){var e=$(this).parent().closest(".fm-field-object"),i=fieldmaster.field_group.get_field_meta(e,"key");fieldmaster.field_group.wipe_field($(this)),fieldmaster.field_group.update_field_meta($(this),"parent",i),fieldmaster.field_group.save_field($(this))}),this.fix_conditional_logic(i))},delete_field:function(e){e.find(".fm-field-object").each(function(){fieldmaster.field_group.delete_field($(this),!1)})},change_field_type:function(e){e.find(".fm-field-object").each(function(){fieldmaster.field_group.delete_field($(this),!1)})}})}(jQuery);