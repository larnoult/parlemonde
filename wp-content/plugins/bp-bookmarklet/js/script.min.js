/*! bp-bookmarklet - v3.0.0 - 2016-03-24 8:22:36 PM UTC - https://github.com/imath/bp-bookmarklet/ */
window.wp=window.wp||{},window.bp=window.bp||{},function(a,b){"undefined"!=typeof BP_Bookmarklet&&(window.bp=_.extend(window.bp,_.pick(window.wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.BookMarklet={start:function(){this.views=new Backbone.Collection,this.items=new bp.Collections.Items,this.postFormView()},postFormView:function(){var a=new bp.Views.PostForm;this.views.add({id:"post_form",view:a}),a.inject("#bookmark-container")},getLinkParams:function(a,b){var c;if(c=a?-1!==a.indexOf("?")?"?"+a.split("?")[1]:"":document.location.search,!c)return null;var d=c.replace(/(^\?)/,"").split("&").map(function(a){return a=a.split("="),this[a[0]]=a[1],this}.bind({}))[0];return b?d[b]:d},stripTags:function(a){return a=a||"",a.replace(/<!--[\s\S]*?(-->|$)/g,"").replace(/<(script|style)[^>]*>[\s\S]*?(<\/\1>|$)/gi,"").replace(/<\/?[a-z][\s\S]*?(>|$)/gi,"")},checkUrl:function(a){return a=b.trim(a||""),/^(?:https?:)?\/\//.test(a)?(a=this.stripTags(a),a.replace(/["\\]+/g,"")):""}},"undefined"==typeof bp.View&&(bp.View=bp.Backbone.View.extend({inject:function(a){this.render(),b(a).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}})),bp.Models.BookMarklet=Backbone.Model.extend({bookmarklet:{user_id:0,item_id:0,object:"",content:"",type:"",url:"",title:"",description:"",images:[],fetched:!1},getSource:function(){var a=this;this.get("url")&&(_.isUndefined(this.get("errors"))||this.unset("errors",{silent:!0}),bp.ajax.post("bp_bookmarklet_fetch_link",{url:a.get("url")}).done(function(b){a.get("title")&&_.isEmpty(b.title)&&(b.title=a.get("title")),a.set(b),a.set("fetching",!1)}).fail(function(b){a.set(b),a.set("fetching",!1)}))}}),bp.Models.Item=Backbone.Model.extend({item:{}}),bp.Collections.Items=Backbone.Collection.extend({model:bp.Models.Item,sync:function(a,b,c){return"read"===a?(c=c||{},c.context=this,c.data=_.extend(c.data||{},{action:"bp_bookmarklet_get_items"}),bp.ajax.send(c)):void 0},parse:function(a){return _.isArray(a)||(a=[a]),a}}),bp.Views.activityWarning=bp.View.extend({tagName:"div",id:"message",initialize:function(){this.value=this.options.value,this.type="info",_.isUndefined(this.options.type)||"info"===this.options.type?this.el.className=this.type:this.type=this.options.type},render:function(){var a;return a="info"===this.type?"<p>"+this.value+"</p>":'<p class="'+this.type+'">'+this.value+"</p>",this.$el.html(a),this}}),bp.Views.ActivityInput=bp.View.extend({tagName:"input",attributes:{type:"text"},initialize:function(){_.isObject(this.options)&&_.each(this.options,function(a,b){this.$el.prop(b,a)},this)}}),bp.Views.WhatsNew=bp.View.extend({tagName:"textarea",className:"bp-suggestions",id:"bp-bookmarklet",attributes:{role:"textbox",name:"bp-bookmarklet",cols:"50",rows:"4",placeholder:BP_Bookmarklet.strings.textareaPlaceholder,"aria-label":BP_Bookmarklet.strings.textareaLabel},initialize:function(){this.options.activity.on("change:content",this.resetContent,this)},resetContent:function(a){_.isUndefined(a)||this.$el.val(a.get("content")).css({height:this.$el.get(0).scrollHeight})}}),bp.Views.WhatsNewPostIn=bp.View.extend({tagName:"select",id:"bp-bookmarklet-post-in",attributes:{name:"bp-bookmarklet-post-in","aria-label":BP_Bookmarklet.strings.selectObject},events:{change:"change"},keys:[],initialize:function(){this.model=new Backbone.Model,this.filters=this.options.filters||{},this.$el.html(_.chain(this.filters).map(function(a,c){return{el:b("<option></option>").val(c).html(a.text)[0],priority:a.priority||50}},this).sortBy("priority").pluck("el").value())},change:function(){var a=this.filters[this.el.value];a&&this.model.set({selected:this.el.value,placeholder:a.autocomplete_placeholder})}}),bp.Views.Item=bp.View.extend({tagName:"li",className:"bp-item",template:bp.template("bookmark-target-item"),attributes:{role:"checkbox"},initialize:function(){this.model.get("selected")&&(this.el.className+=" selected")},events:{click:"setObject"},setObject:function(a){a.preventDefault(),!0===this.model.get("selected")?this.model.clear():this.model.set("selected",!0)}}),bp.Views.AutoComplete=bp.View.extend({tagName:"ul",id:"bp-bookmarklet-post-in-box-items",events:{keyup:"autoComplete"},initialize:function(){var a=new bp.Views.ActivityInput({type:"text",id:"bookmark-item-autocomplete",placeholder:this.options.placeholder||""}).render();this.$el.prepend(b("<li></li>").html(a.$el)),this.on("ready",this.setFocus,this),this.collection.on("add",this.addItemView,this),this.collection.on("reset",this.cleanView,this)},setFocus:function(){this.$el.find("#bookmark-item-autocomplete").focus()},addItemView:function(a){this.views.add(new bp.Views.Item({model:a}))},autoComplete:function(){var a=b("#bookmark-item-autocomplete").val();this.collection.reset(),2>a.length||this.collection.fetch({data:{type:this.options.type,search:a},success:_.bind(this.itemFetched,this),error:_.bind(this.itemFetched,this)})},itemFetched:function(a){a.length||this.cleanView()},cleanView:function(){_.each(this.views._views[""],function(a){a.remove()})}}),bp.Views.FormContent=bp.View.extend({tagName:"div",id:"bp-bookmarklet-content",template:bp.template("bookmark-post-form-content"),initialize:function(){this.model=new Backbone.Model(_.pick(BP_Bookmarklet.params,["user_id","avatar_url","avatar_width","avatar_height","avatar_alt","user_domain"])),this.model.has("avatar_url")&&this.model.set("display_avatar",!0),this.views.set("#bp-bookmarklet-textarea",new bp.Views.WhatsNew({activity:this.options.activity}))}}),bp.Views.FormTarget=bp.View.extend({tagName:"div",id:"bp-bookmarklet-post-in-box",className:"in-profile",initialize:function(){var a=new bp.Views.WhatsNewPostIn({filters:BP_Bookmarklet.params.objects});this.views.add(a),a.model.on("change",this.attachAutocomplete,this),bp.BookMarklet.items.on("change:selected",this.postIn,this)},attachAutocomplete:function(a){0!==bp.BookMarklet.items.models.length&&bp.BookMarklet.items.reset(),_.each(this.views._views[""],function(a){_.isUndefined(a.collection)||a.remove()}),"profile"!==a.get("selected")?(this.views.add(new bp.Views.AutoComplete({collection:bp.BookMarklet.items,type:a.get("selected"),placeholder:a.get("placeholder")})),this.model.set("object",a.get("selected"))):this.model.set({object:"user",item_id:0}),this.updateDisplay()},postIn:function(a){return _.isUndefined(a.get("id"))?(this.model.set("item_id",0),void this.attachAutocomplete(new Backbone.Model({selected:this.model.get("object")}))):(this.model.set("item_id",a.get("id")),void this.views.set("#bp-bookmarklet-post-in-box-items",new bp.Views.Item({model:a})))},updateDisplay:function(){"user"!==this.model.get("object")?this.$el.removeClass():this.$el.hasClass("in-profile")||this.$el.addClass("in-profile")}}),bp.Views.FormSubmit=bp.View.extend({tagName:"div",id:"bp-bookmarklet-submit",className:"in-profile",initialize:function(){var a=new bp.Views.ActivityInput({type:"reset",id:"bp-bookmarklet-reset-button",value:BP_Bookmarklet.strings.cancelText}),b=new bp.Views.ActivityInput({type:"submit",id:"bp-bookmarklet-submit-button",name:"bp-bookmarklet-submit-button",value:BP_Bookmarklet.strings.submitText});this.views.add(b),this.views.add(a),this.model.on("change:object",this.updateDisplay,this)},updateDisplay:function(a){_.isUndefined(a)||("user"!==a.get("object")?this.$el.removeClass("in-profile"):this.$el.hasClass("in-profile")||this.$el.addClass("in-profile"))}}),bp.Views.FormLink=bp.View.extend({tagName:"div",id:"bp-bookmarklet-link",events:{"blur #activity-link":"loadContent"},initialize:function(){var a=new bp.Views.ActivityInput({type:"text",id:"activity-link",placeholder:"http://",readonly:"readonly"}).render();this.$el.prepend(b("<div></div>").html(a.$el)),this.on("ready",this.setFocus,this),this.model.on("change:type",this.setBookmark,this),this.model.on("change:errors",this.setBookmark,this),this.model.on("change:fetching",this.refreshContent,this)},setFocus:function(){var a=bp.BookMarklet.getLinkParams(),c=this,d=this.$el.find("#activity-link");_.isUndefined(a.url)?d.focus():(b.map(a,function(a,b){if(-1!==_.indexOf(["title","description","copied"],b)){var d=b;"copied"===b&&(d="content"),_.isNull(a)||"null"===a||c.model.set(d,decodeURIComponent(a))}}),d.val(decodeURIComponent(a.url)),d.trigger("blur"))},setBookmark:function(a){var b=a.get("images")||[];if(a.get("errors")){if(_.isArray(a.get("errors"))&&a.set({errors:{type:"info",value:_.first(a.get("errors"))},fetching:!1},{silent:!0}),!a.get("title"))return;a.set({type:"link",images:[""]},{silent:!0}),this.model.unset("errors")}else a.get("title")&&!1===a.get("fetching")&&("link"===a.get("type")&&0!==b.length&&a.set("image",_.first(b)),this.views.add(new bp.Views.linkOutput({model:a})),1<b.length&&this.views.add(new bp.Views.imageSelector({model:a})))},loadContent:function(a){var c=bp.BookMarklet.checkUrl(b(a.target).val());""!==c&&this.model.get("url")!==c&&(this.model.set({url:c,type:"",fetching:!0}),this.model.unset("errors"),this.model.getSource())},refreshContent:function(a){a.get("title")||_.each(this.views._views[""],function(a){a.remove()}),!0===a.get("fetching")?this.$el.append('<div id="loader"></div>'):this.$el.find("#loader").remove()}}),bp.Views.linkOutput=bp.View.extend({tagName:"div",className:"link-output",template:bp.template("bookmark-link-output"),events:{"click #bookmarklet-no-image":"removeImage"},initialize:function(){this.on("ready",this.insertEmbed,this)},insertEmbed:function(){"oembed"===this.model.get("type")&&this.model.get("description")&&this.$el.find("#oembed-preview").html(this.model.get("description"))},removeImage:function(a){a.preventDefault(),this.model.set("image",""),b("#bp-bookmarklet-link .thumbnail-preview").addClass("noimage"),b("#bp-bookmarklet-link .link-image").each(function(a,c){b(c).removeClass("selected")})}}),bp.Views.imageSelector=bp.View.extend({tagName:"ul",className:"link-images",events:{"click .link-image":"setImage"},initialize:function(){_.each(this.model.get("images"),function(a){var c="";a===this.model.get("image")&&(c="selected"),this.$el.append(b("<li></li>").html('<a href="#" class="link-image '+c+'" role="checkbox" style="background:url('+a+')" data-image="'+a+'"></a>'))},this)},setImage:function(a){a.preventDefault();var c=b(a.target).data("image");b(".link-image").each(function(){var a=b(this);a.hasClass("selected")&&a.removeClass("selected")}),this.model.set("image",c),b(a.target).addClass("selected"),b("#bp-bookmarklet-link .link-thumbnail").prop("src",c),b("#bp-bookmarklet-link .thumbnail-preview").removeClass("noimage")}}),bp.Views.PostForm=bp.View.extend({tagName:"form",className:"bookmarklet-form",events:{reset:"resetForm",submit:"postUpdate"},initialize:function(){this.model=new bp.Models.BookMarklet(_.pick(BP_Bookmarklet.params,["user_id","item_id","object"])),this.resetModel=this.model.clone(),this.resetModel.set("fetched",!1),this.views.add(new bp.Views.FormLink({model:this.model})),this.model.on("change:errors",this.displayFeedback,this),this.model.on("change:title",this.displayFull,this)},displayFull:function(){1!==this.views._views[""].length||_.isUndefined(this.model.get("title"))||(this.views.add(new bp.Views.FormContent({activity:this.model})),!_.isUndefined(BP_Bookmarklet.params.objects)&&1<_.keys(BP_Bookmarklet.params.objects).length&&this.views.add(new bp.Views.FormTarget({model:this.model})),this.views.add(new bp.Views.FormSubmit({model:this.model})))},resetForm:function(){_.each(this.views._views[""],function(a,b){0!==b&&a.remove()}),this.model.clear(),this.model.set(this.resetModel.attributes),this.maybeClose()},clearFeedback:function(){_.each(this.views._views[""],function(a){"message"===a.$el.prop("id")&&a.remove()})},displayFeedback:function(a){_.isUndefined(this.model.get("errors"))?this.clearFeedback():this.views.add(new bp.Views.activityWarning(a.get("errors")))},postUpdate:function(a){var b=this,c={},d=[];if(a&&a.preventDefault(),_.each(this.$el.serializeArray(),function(a){a.name=a.name.replace("[]",""),"bp-bookmarklet"===a.name?b.model.set("content",a.value):-1===_.indexOf(["bp-bookmarklet-submit-button","bp-bookmarklet-post-in"],a.name)&&(_.isUndefined(c[a.name])?c[a.name]=a.value:(_.isArray(c[a.name])||(c[a.name]=[c[a.name]]),c[a.name].push(a.value)))}),this.clearFeedback(),!0!==this.model.get("fetching")&&this.model.get("title")&&this.model.get("url")||d.push({type:"error",value:BP_Bookmarklet.strings.errorGeneric}),"group"!==this.model.get("object")||this.model.get("item_id")||d.push({type:"error",value:BP_Bookmarklet.strings.errorObject}),0<d.length)return void _.each(d,function(a){b.views.add(new bp.Views.activityWarning(a))});this.model.set("meta",c);var e={_wpnonce_bookmarklet_create:BP_Bookmarklet.params.post_nonce};bp.ajax.post("bp_bookmarklet_post_update",_.extend(e,this.model.attributes)).done(function(a){b.resetForm(),b.views.add(new bp.Views.activityWarning({type:"info",value:a.message})),b.maybeClose()}).fail(function(a){b.views.add(new bp.Views.activityWarning({type:"error",value:a.error}))})},maybeClose:function(){"doclose"===bp.BookMarklet.getLinkParams(null,"jump")&&setTimeout(function(){window.close()},1e3)}}),bp.BookMarklet.start())}(bp,jQuery);